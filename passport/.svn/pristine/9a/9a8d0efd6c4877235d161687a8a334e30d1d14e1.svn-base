package cn.easywed.stargate.controller;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import cn.easywed.stargate.common.util.JsonUtil;
import cn.easywed.stargate.common.util.MD5Util;
import cn.easywed.stargate.dao.persistence.Auth;
import cn.easywed.stargate.dao.persistence.RRoleAuth;
import cn.easywed.stargate.dao.persistence.RUserRole;
import cn.easywed.stargate.dao.persistence.Role;
import cn.easywed.stargate.dao.persistence.User;
import cn.easywed.stargate.service.IAuthService;
import cn.easywed.stargate.service.IRerationService;
import cn.easywed.stargate.service.IRoleService;
import cn.easywed.stargate.service.IUserService;

@RequestMapping("/")
@Controller
public class AppController {
	
	 //private static  Logger logger = null;

	@Resource
	IUserService userService;

	@Resource
	IRerationService rerationService;

	@Resource
	IRoleService roleService;

	@Resource
	IAuthService authService;


	/**
	 * 登录
	 * @param request
	 * @return
	 */
	@RequestMapping(value = "/login", method = { RequestMethod.POST })
	@ResponseBody
	public String login(HttpServletRequest request, String mobile,String password) {
		Map<String, Object> retMap = new HashMap<String, Object>();
		retMap.put("code", 0);
		retMap.put("msg", "ok");
//		logger.info("intput mobile is: "+ mobile);
//		logger.info("intput password is: "+ password);

		System.out.println("parameta is:  " + mobile +" "+ password);
		String pw = MD5Util.MD5(password);
				
		User userInfo = userService.getUserInfo(mobile, pw);
		if (userInfo == null) {
			retMap.put("code", 1);
			retMap.put("msg", "mobile password is wrong");
			return JsonUtil.toJson(retMap);
		}

		Map<String, Object> dataMap = new HashMap<String, Object>();
		dataMap.put("userInfo", userInfo);
		long uid = userInfo.getId();
		// 获取角色列表
		List<RUserRole> rUserRoles = rerationService.getByUId(uid);
		// 角色
		List<Role> roleList = new ArrayList();
		// 权限
		List<Auth> authList = new ArrayList();

		List roleids = new ArrayList();
		Map authMap = new HashMap();
		for (int i = 0; i < rUserRoles.size(); i++) {
			roleids.add(rUserRoles.get(i).getRoleId());
			// 获取角色
			Role role = roleService.getById(rUserRoles.get(i).getRoleId());
			roleList.add(role);

		}
		// 根据roleids获取权限列表
		if (roleids.size() > 0) {
			List<RRoleAuth> rroleAuth = rerationService.getByRoleIds(roleids);
			// 获取权限列表
			for (int i = 0; i < rroleAuth.size(); i++) {
				// 获取权限详情
				Auth auth = authService.getById(rroleAuth.get(i).getAuthId());
				authList.add(auth);

			}

		}
		dataMap.put("role", roleList);
		dataMap.put("auth", authList);
		retMap.put("data", dataMap);
		return JsonUtil.toJson(retMap);

	}

	// /**
	// * 获取已登录用户权限 POST
	// * @throws Exception
	// */
	// @RequestMapping(value = "/getUserAuth",method = {RequestMethod.POST})
	// public String getAuth(HttpServletRequest request) {
	//
	// Map<String,Object> retMap=new HashMap<String ,Object>();
	// retMap.put("code",200);
	// retMap.put("msg", "ok");
	//
	// Map<String,Object> dataMap=new HashMap<String ,Object>();
	// List authList =new ArrayList();
	// try {
	// String roles=request.getParameter("roles");
	//
	// String[] role = roles.split(",");
	// for (int i = 0 ; i <role.length ; i++ ) {
	//
	// int roleId= Integer.parseInt(role[i]);
	//
	// List<RRoleAuth> rRoleAuth=rerationService.getByRoleId(roleId);
	// if(rRoleAuth!=null){
	// for (int j = 0 ; j <rRoleAuth.size() ; j++ ) {
	// authList.add(rRoleAuth.get(j).getAuthId());
	// }
	// }
	// }
	// dataMap.put("auth", authList);
	// retMap.put("data", dataMap);
	// }catch (NumberFormatException e){
	// retMap.put("code",500);
	// retMap.put("msg", "input param error");
	// return JsonUtil.toJson(retMap);
	// }
	//
	//
	// return JsonUtil.toJson(retMap);
	//
	// }

}
